# 10.01. Зачем и что нужно мониторить — Алексей Храпов

## Обязательные задания

1. Вас пригласили настроить мониторинг на проект. На онбординге вам рассказали, что проект представляет из себя 
платформу для вычислений с выдачей текстовых отчетов, которые сохраняются на диск. Взаимодействие с платформой 
осуществляется по протоколу http. Также вам отметили, что вычисления загружают ЦПУ. Какой минимальный набор метрик вы
выведите в мониторинг и почему?

### **Ответ:**

Для начальной кофигурации системы мониторинга взял бы базовые метрики, далее набор метрик увеличивал бы по мере необходимости для критичных сервисов. Такой подход позволит наблюдать наиболее важные детали работы платформы, при этом потребление ресурсов будет невысоким, кроме того базовые метрики, как правило, присутствуют в большинстве систем мониторинга, что ускорит процесс её внедрения. Также необходимо будет настроить автоматическое оповещение для системных метрик на пороговые значения. 

Для наглядности разобьем мониторинг на логические составляющие:
- Инфраструктура
- Безопасность
- Системное ПО
- Бизнес-процессы

1. **Мониторинг инфраструктуры**

- CPU:
Фиксируется постоянно высокий уровень нагрузки в течение определенного времени.

|Метрика|Условие оповещения|
|:---|:---|
|CPU idle|менее 10% в течение 10 минут|
|CPU Load Average|превышает количество доступных процессоров и не равно 0 в течение 5 минут|

- ОЗУ: оценивается загруженность и начало процесса деградации.

|Метрика|Условие оповещения|
|:---|:---|
|заполнение SWAP|более 90%|
|активная запись в SWAP|swapin > 1 Мбайт/с в течение 2-5 минут|
|используемая оперативная память|более 85% от установленного объема|

- Диск

|Метрика|Условие оповещения|
|:---|:---|
|свободное место (для каждого раздела)|10% и менее|
|iostat|более 95% на протяжении часа|
|свободные inodes|менее 10%|

- Сеть

|Метрика|Условие оповещения|
|:---|:---|
|средняя нагрузка на передачу|более 75% на канал|
|средняя нагрузка на прием|более 75% на канал|
|доступность по http|не доступно более 4 запросов (запрос раз в 5 с)|
|время отклика сервера|*более 500 мс|

*В случае, если сервер в локальной сети, то стоит уменьшить до 100 мс

- Синхронизация времени

|Метрика|Условие оповещения|
|:---|:---|
|рассинхронизация с заданным сервером|отклонение от эталона в 0,5с в течение 5 минут|

2. **Безопасность**

|Метрика|Условие оповещения|
|:---|:---|
|количество неудачных авторизаций|более 4-х|
|актуальность сертификатов|срок действия истекает через 15 дней|

Полезно будет отслеживать изменение количества привелегированных пользователей и ошибки типа 4хх и 5хх.

3. **Системное ПО**

В зависимости от используемого ПО (БД, веб-сервисы, серверы приложений и т.д.) проверяются его основные показатели, предоставляемые самим приложением или собираемые агентами системы мониторинга. 

|Метрика|Условие оповещения|
|:---|:---|
|HTTP CODE|отличается от 2хх или 3хх в течение 3 минут|
|RESPONSE TIME|выше «нормального» в течение 3 минут|

Также можно проверять наличие необходимого контента в определенных разделах сайта и его доступность из разных географических расположений.

4. **Бизнес-процессы**

Для грамотного планирования бюджета на содержание ИТ-инфраструктуры необходимо знать характеристики нагрузки бизнес-процессов на инфраструктуру. Я выделю следующие метрики:

- количество активных пользователей в системе;
- общее количество сохраненных отчётов;
- время выполнения запроса на прдоставление отчета в течение 5 минут;
- количество запросов на отчёты в течение 5 минут;
- количество выполненных отчётов в течение 5 минут;
- географический объём распределения сетевого трафика.

---

2. Менеджер продукта посмотрев на ваши метрики сказал, что ему непонятно что такое RAM/inodes/CPUla. Также он сказал, 
что хочет понимать, насколько мы выполняем свои обязанности перед клиентами и какое качество обслуживания. Что вы 
можете ему предложить?

### **Ответ:**

Я бы ещё раз уточнил обязанности перед клиентом в SLA (если их нет, то предложил изложить, на примере метрик, на основании SLA и реальных возможностей обозначить SLO (метрики и их критические значения, которые не должны достигаться), например. SLI будет показывать фактические метрики, на их основании уже можно будет судить о том, насколько мы выполняем свои обязанности перед клиентами и какое качество обслуживания.

На дашборд вынести метрики SLI и подписать их человеко-понятным языком с интуитивно-понятным отображением (условно: зеленый цвет - в пределах нормы, оранжевый - близость критического значения, красный - критическое значение или его превышение). Например, вместо RAM - объем оперативной памяти, inodes - количество файловых дескрипторов (которые хранят информацию о файлах системыи), CPUla - загрузка процессора. Добавить оповещения об отклонении SLI от требуемых значений.

Рассказать о работе системы, чтобы установить понятийный аппарат и, если это необходимо, поднять уровень знаний всей команды для понимания уровня критичности метрик для сервиса. 

Пример именования метрик для менеджера с описанием их критических значений:

|Метрика|Описание критического значения|
|:---|:---|
|Бездействие системы|менее 10% в течение 10 минут|
|Средняя загрузка ЦП|превышает количество доступных процессоров и не равно 0 в течение 5 минут|
|Заполнение файла подкачки|более 90%|
|Используемая оперативная память|более 85% от установленного объема|
|Свободное место на диске|10% и менее|
|Cвободные файловые дескрипторы|менее 10%|
|Средняя нагрузка на канал передачи данных|более 75%|
|Доступность по http|не доступно более 4 запросов (запрос раз в 5 с)|
|Время отклика сервера|более 500 мс|
|Время ожидания ответа|выше «нормального» в течение 3 минут|

Пример дополнительного дашборда со сводками по отработке метрик:

|Метрика|Количество превышений критических значений|Общее время работы с превышением критических значений метрик| SLO соблюден|
|:---|:---:|:---|:---:|
|Бездействие системы|0|0 с|да|
|Средняя загрузка ЦП|2|1 мин 34 с|да|
|Заполнение файла подкачки|1| 20 мин 0 с|да|
|Используемая оперативная память|3|34 мин 16 с|да|
|Свободное место на диске|0|0 c|да|
|Cвободные файловые дескрипторы|0|0 c|да|
|Средняя нагрузка на канал передачи данных|2|10 мин 52 с|да|
|Доступность по http|0|0 c|да|
|Время отклика сервера|0|0 c|да|
|Время ожидания ответа|3|35 мин 1 с|да|

Также можно добавить текущее значение SLI.

---

3. Вашей DevOps команде в этом году не выделили финансирование на построение системы сбора логов. Разработчики в свою 
очередь хотят видеть все ошибки, которые выдают их приложения. Какое решение вы можете предпринять в этой ситуации, 
чтобы разработчики получали ошибки приложения?

### **Ответ:**

Есть 2 варинта для решения:

1. Можно самостоятельно написать скрипты, которые будут оповещать разработчиков об ошибках по почте или через месенджеры (telegram, slack).
2. Можно использовть бесплатную облачную версию Sentry.

---

3. Вы, как опытный SRE, сделали мониторинг, куда вывели отображения выполнения SLA=99% по http кодам ответов. 
Вычисляете этот параметр по следующей формуле: summ_2xx_requests/summ_all_requests. Данный параметр не поднимается выше 
70%, но при этом в вашей системе нет кодов ответа 5xx и 4xx. Где у вас ошибка?

### **Ответ:**

Ошибка в формуле (не учитываются только успешные коды). Если добавить информационные коды и коды перенаправления, то ситуация изменится.
(summ_1xx_requests + summ_2xx_requests + summ_3xx_requests)/(summ_all_requests)

---

## Дополнительное задание (со звездочкой*) - необязательно к выполнению

Вы устроились на работу в стартап. На данный момент у вас нет возможности развернуть полноценную систему 
мониторинга, и вы решили самостоятельно написать простой python3-скрипт для сбора основных метрик сервера. Вы, как 
опытный системный-администратор, знаете, что системная информация сервера лежит в директории `/proc`. 
Также, вы знаете, что в системе Linux есть  планировщик задач cron, который может запускать задачи по расписанию.

Суммировав все, вы спроектировали приложение, которое:
- является python3 скриптом
- собирает метрики из папки `/proc`
- складывает метрики в файл 'YY-MM-DD-awesome-monitoring.log' в директорию /var/log 
(YY - год, MM - месяц, DD - день)
- каждый сбор метрик складывается в виде json-строки, в виде:
  + timestamp (временная метка, int, unixtimestamp)
  + metric_1 (метрика 1)
  + metric_2 (метрика 2)
  
     ...
     
  + metric_N (метрика N)
  
- сбор метрик происходит каждую 1 минуту по cron-расписанию

Для успешного выполнения задания нужно привести:

а) работающий код python3-скрипта,

б) конфигурацию cron-расписания,

в) пример верно сформированного 'YY-MM-DD-awesome-monitoring.log', имеющий не менее 5 записей,

P.S.: количество собираемых метрик должно быть не менее 4-х.
P.P.S.: по желанию можно себя не ограничивать только сбором метрик из `/proc`.

### **Ответ:**

<details><summary><a href="src/monitoring.py">а) работающий код python3-скрипта</a></summary>

```python
#!/usr/bin/python3
import psutil
import json
from datetime import datetime as dt

result = dict()

now = dt.now()
result['timestamp'] = now.strftime("%s")

#Uptime data (hms format)
def get_uptime_data():
    with open('/proc/uptime', 'r') as log:
        uptime_seconds = int(float(log.read().split(' ')[0].strip()))
    return str(uptime_seconds // 3600) + "h" \
        + str((uptime_seconds % 3600) // 60) + "m" \
        + str(uptime_seconds % 3600 % 60) + "s" 
result['uptime'] = get_uptime_data()

#Running processes
def get_processes_data():
    processes_data = dict()
    with open('/proc/loadavg', 'r') as f:
        for string in f:
            la_1m, la_5m, la_15m, proc_info, newest_pid = string.split(' ')
            running, total = proc_info.split('/')
    processes_data['running'] = int(running)
    processes_data['total'] = int(total)
    return processes_data
result['processes'] = get_processes_data()

#CPU load
result['cpuload_percent'] = psutil.cpu_percent(interval=1)
#Virtual memory load
result['vmload_percent'] = psutil.virtual_memory().percent
#swap lod
result['swapload_percent'] = psutil.swap_memory().percent

#Disks read load
result['disk_io_read'] = psutil.disk_io_counters().read_count
#Disks write load
result['disk_io_write'] = psutil.disk_io_counters().write_count


#Bytes sent
result['net_bytes_sent'] = psutil.net_io_counters().bytes_sent
#Bytes recieved
result['net_bytes_recieved'] = psutil.net_io_counters().bytes_recv

filepath = "/var/log/"+now.strftime("%y-%m-%d")+"-awesome-monitoring.log"

with open(filepath, "a") as log:
    log.write(json.dumps(result)+"\n")
```

</details>

б) конфигурация cron-расписания:
```bash
* * * * * root python3 /opt/monitoring.py
```

в) [пример верно сформированного 'YY-MM-DD-awesome-monitoring.log](./src/22-07-24-awesome-monitoring.log), имеющий не менее 5 записей:

```
{"timestamp": "1658676541", "uptime": "1008h17m40s", "processes": {"running": 1, "total": 934}, "cpuload_percent": 1.3, "vmload_percent": 28.6, "swapload_percent": 0.3, "disk_io_read": 131187, "disk_io_write": 6304436, "net_bytes_sent": 8611854865, "net_bytes_recieved": 22669499192}
{"timestamp": "1658676601", "uptime": "1008h18m40s", "processes": {"running": 1, "total": 931}, "cpuload_percent": 0.3, "vmload_percent": 28.6, "swapload_percent": 0.3, "disk_io_read": 131187, "disk_io_write": 6304629, "net_bytes_sent": 8611963805, "net_bytes_recieved": 22669591413}
{"timestamp": "1658676661", "uptime": "1008h19m40s", "processes": {"running": 1, "total": 931}, "cpuload_percent": 0.3, "vmload_percent": 28.6, "swapload_percent": 0.3, "disk_io_read": 131187, "disk_io_write": 6304758, "net_bytes_sent": 8611966327, "net_bytes_recieved": 22669604500}
{"timestamp": "1658676721", "uptime": "1008h20m40s", "processes": {"running": 1, "total": 931}, "cpuload_percent": 0.3, "vmload_percent": 28.6, "swapload_percent": 0.3, "disk_io_read": 131187, "disk_io_write": 6304912, "net_bytes_sent": 8611980265, "net_bytes_recieved": 22669635852}
{"timestamp": "1658676781", "uptime": "1008h21m40s", "processes": {"running": 1, "total": 931}, "cpuload_percent": 0.3, "vmload_percent": 28.6, "swapload_percent": 0.3, "disk_io_read": 131187, "disk_io_write": 6305088, "net_bytes_sent": 8611985385, "net_bytes_recieved": 22669653086}
{"timestamp": "1658676841", "uptime": "1008h22m40s", "processes": {"running": 1, "total": 931}, "cpuload_percent": 1.7, "vmload_percent": 28.6, "swapload_percent": 0.3, "disk_io_read": 131187, "disk_io_write": 6305208, "net_bytes_sent": 8612112606, "net_bytes_recieved": 22669727442}
{"timestamp": "1658676901", "uptime": "1008h23m41s", "processes": {"running": 1, "total": 932}, "cpuload_percent": 0.5, "vmload_percent": 28.6, "swapload_percent": 0.3, "disk_io_read": 131187, "disk_io_write": 6305400, "net_bytes_sent": 8612116147, "net_bytes_recieved": 22669740002}
```

---